# ğŸ³ Luna Production - Full Stack Dockerfile for Coolify
# Single container with built client and server
# FORCE REBUILD: 2025-01-12-09:30 - Fix TypeScript compilation issue with licenseContent

# Stage 1: Build Client
FROM node:18-alpine AS client-builder

# FORCE CACHE BUST - Unique timestamp 
ARG CACHEBUST=2025-01-12-debug-frontend
RUN echo "ğŸ”§ Cache bust: $CACHEBUST - Comprehensive frontend debugging"

WORKDIR /app/client

# Install dependencies first
COPY client/package*.json ./
RUN echo "ğŸ“¦ Installing frontend dependencies..." && \
    npm ci --silent && \
    echo "âœ… Frontend dependencies installed" && \
    ls -la node_modules/.bin/ | head -10

# Copy source code
COPY client/ ./
RUN echo "ğŸ“ Frontend source copied. Contents:" && \
    ls -la && \
    echo "ğŸ“„ TypeScript config:" && \
    cat tsconfig.json && \
    echo "ğŸ“„ Vite config:" && \
    cat vite.config.ts

# Build with comprehensive debugging
RUN echo "ğŸ”§ Starting frontend build process..." && \
    echo "ğŸ“Š Node version: $(node --version)" && \
    echo "ğŸ“Š NPM version: $(npm --version)" && \
    echo "ğŸ“Š TypeScript version: $(npx tsc --version)" && \
    echo "ğŸ“Š Vite version: $(npx vite --version)" && \
    echo "ğŸ”§ Running TypeScript compilation..." && \
    npx tsc --noEmit && \
    echo "âœ… TypeScript compilation successful" && \
    echo "ğŸ”§ Running Vite build..." && \
    npx vite build --logLevel info && \
    echo "âœ… Vite build completed" && \
    echo "ğŸ“ Build output:" && \
    ls -la dist/ && \
    echo "ğŸ“„ Files in dist:" && \
    find dist -type f | head -20 && \
    echo "ğŸ“Š Dist directory size: $(du -sh dist)" && \
    echo "âœ… Frontend build process completed successfully"

# Stage 2: Build Server
FROM node:18-bullseye AS server-builder

# FORCE CACHE BUST - Unique timestamp 
ARG CACHEBUST=2025-01-12-09:30
RUN echo "Server cache bust: $CACHEBUST - Forcing fresh server build with fixed TypeScript compilation"

# Install system dependencies
RUN apt-get update && apt-get install -y \
    openjdk-11-jre \
    openjdk-11-jdk \
    python3 \
    make \
    g++ \
    gcc \
    build-essential \
    fontconfig \
    fonts-dejavu \
    && rm -rf /var/lib/apt/lists/*

# Set Java environment
ENV JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
ENV PATH="$JAVA_HOME/bin:${PATH}"
ENV JAVA_TOOL_OPTIONS="-Djava.awt.headless=true -Dfile.encoding=UTF-8"
ENV LD_LIBRARY_PATH="$JAVA_HOME/lib/server:$JAVA_HOME/lib:${LD_LIBRARY_PATH:-}"

WORKDIR /app

# Copy package files
COPY package*.json ./
COPY server/package*.json ./server/

# Install ALL dependencies (including devDependencies for TypeScript build)
WORKDIR /app/server
RUN npm ci

WORKDIR /app
RUN npm ci

# Install Java module
RUN export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64 && \
    npm install java@0.14.0 --build-from-source

# Copy and build server
COPY lib/ ./lib/
COPY server/ ./server/

# Copy Aspose license file (optional - create empty if not exists)
RUN touch Aspose.Slides.Product.Family.lic
COPY Aspose.Slides.Product.Family.lic* ./

WORKDIR /app/server
RUN npm run build

# âœ… GENERATE OPENAPI DOCUMENTATION AT BUILD TIME
# This fixes the Swagger UI empty endpoints problem
RUN echo "ğŸ”§ Generating OpenAPI documentation using existing swagger config..." && \
    node -e " \
    const { generateSwaggerSpec } = require('./dist/swagger/swagger.config.js'); \
    const fs = require('fs'); \
    try { \
      const spec = generateSwaggerSpec(); \
      fs.writeFileSync('./dist/openapi.json', JSON.stringify(spec, null, 2)); \
      console.log('âœ… OpenAPI spec generated successfully with', Object.keys(spec.paths || {}).length, 'endpoints'); \
    } catch (error) { \
      console.error('âŒ Error generating OpenAPI spec:', error.message); \
      const fallbackSpec = { \
        openapi: '3.0.0', \
        info: { title: 'Luna Server API', version: '1.0.0', description: 'Professional PowerPoint processing API with AI capabilities' }, \
        servers: [{ url: 'https://luna.anlaklab.com/api/v1', description: 'Production' }], \
        paths: {} \
      }; \
      fs.writeFileSync('./dist/openapi.json', JSON.stringify(fallbackSpec, null, 2)); \
      console.log('âš ï¸ Generated fallback OpenAPI spec'); \
    } \
    " && \
    ls -la dist/openapi.json

# Stage 3: Production
FROM node:18-bullseye AS production

# Install runtime dependencies
RUN apt-get update && apt-get install -y \
    openjdk-11-jre \
    nginx \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Set Java environment
ENV JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
ENV PATH="$JAVA_HOME/bin:${PATH}"
ENV JAVA_TOOL_OPTIONS="-Djava.awt.headless=true -Dfile.encoding=UTF-8"
ENV LD_LIBRARY_PATH="$JAVA_HOME/lib/server:$JAVA_HOME/lib:${LD_LIBRARY_PATH:-}"

WORKDIR /app

# Copy built client
RUN echo "ğŸ“ Copying frontend to production locations..." && \
    echo "ğŸ” Checking client-builder dist:" && \
    ls -la /app/client/dist || echo "âŒ Client dist not found"

COPY --from=client-builder /app/client/dist /var/www/html

# ALSO copy to expected server location for fallback/direct serving
COPY --from=client-builder /app/client/dist /app/client/dist

# Verify frontend files are in place
RUN echo "âœ… Frontend files copied. Verifying locations:" && \
    echo "ğŸ“ /var/www/html contents:" && \
    ls -la /var/www/html && \
    echo "ğŸ“„ Files in /var/www/html:" && \
    find /var/www/html -type f | head -10 && \
    echo "ğŸ“ /app/client/dist contents:" && \
    ls -la /app/client/dist && \
    echo "ğŸ“„ Files in /app/client/dist:" && \
    find /app/client/dist -type f | head -10 && \
    echo "ğŸ” Checking for index.html:" && \
    ls -la /var/www/html/index.html && \
    ls -la /app/client/dist/index.html && \
    echo "âœ… Frontend verification completed"

# Copy server package files and install production dependencies
COPY --from=server-builder /app/server/package*.json ./server/
WORKDIR /app/server
RUN npm ci --only=production

# Copy built server and other runtime files
WORKDIR /app
COPY --from=server-builder /app/server/dist ./server/dist
COPY --from=server-builder /app/lib ./lib
COPY --from=server-builder /app/node_modules ./node_modules
COPY --from=server-builder /app/Aspose.Slides.Product.Family.lic ./

# Copy nginx configuration
COPY nginx.production.conf /etc/nginx/nginx.conf

# Create necessary directories
RUN mkdir -p /app/temp/{uploads,aspose,conversions,thumbnails} /app/logs

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:3000/api/v1/health || exit 1

EXPOSE 80

# Start script
COPY start-production.sh /start.sh
RUN chmod +x /start.sh

CMD ["/start.sh"] 